# This runs code signing for .nupkg files built on MacOS or Linux
parameters:
  inputName: ''

jobs:
- template: default-build.yml
  parameters:
    codeSign: true
    dependsOn:
    - ${{ parameters.inputName }}_build
    condition: and(in(variables['_SignType'], 'test', 'real'), in(dependencies.${{ parameters.inputName }}_build.result, 'Succeeded', 'SucceededWithIssues'))
    jobName: CodeSign_Xplat_${{ parameters.inputName }}
    jobDisplayName: "Code-sign ${{ parameters.inputName }} packages"
    agentOs: Windows
    installNodeJs: false
    installJdk: false
    variables:
    - DOTNET_HOME: $(Build.SourcesDirectory)/.dotnet
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: Download ${{ parameters.inputName }} artifacts
      inputs:
        artifactName: ${{ parameters.inputName }}_Packages
        downloadPath: $(Build.StagingDirectory)/deps/
        itemPattern: '**/*.nupkg'
    - powershell: . ./activate.ps1
      displayName: Activate
    - script: restore.cmd -ci
      displayName: Restore tools
    - task: MSBuild@1
      displayName: Code-sign .nupkg files
      inputs:
        solution: eng\tools\XplatPackageSigner\XplatPackageSigner.csproj
        configuration: $(BuildConfiguration)
        msbuildArguments: /p:SignType=$(_SignType)
          /p:DirectoryToSign=$(Build.StagingDirectory)\deps\${{ parameters.inputName }}_Packages\
          /bl:$(Build.SourcesDirectory)/artifacts/log/CodeSign_Xplat_${{ parameters.inputName }}.binlog
    - powershell: .\eng\common\build.ps1
        -ci
        -publish
        -configuration $(BuildConfiguration)
        /p:AssetManifestFileName=aspnetcore-${{ parameters.inputName }}-signed.xml
        $(_PublishArgs)
      displayName: Publish packages
    artifacts:
    - name: ${{ parameters.inputName }}_Packages_Signed
      path: artifacts/packages/
    - name: CodeSign_Xplat_${{ parameters.inputName }}_Logs
      path: artifacts/log/
      publishOnError: true
